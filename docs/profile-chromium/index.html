<!doctype html><html lang=zh-CN><meta charset=utf-8><title>使用 V8 分析 Chromium · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="本文档介绍了如何在 Chromium 中使用 V8 的 CPU 和堆分析器。" name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li class=active><a href=/docs/ >文档</a><li><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a><li><a href=/grant>Research</a></ul></nav></header><main id=main><h1>使用 V8 分析 Chromium</h1><p>从 V8 的 shell 程序中使用 <a href=/docs/profile>V8 的 CPU 和 堆分析器</a>很简单，但是如何将它们与 Chromium 一起使用可能会感到困惑。此页面可以给你提供帮助。<h2 id=why-is-using-v8’s-profilers-with-chromium-different-from-using-them-with-v8-shells?>为什么在 Chromium 中使用 V8 分析器与在 V8 shell 中使用它们不同？ <a href=#why-is-using-v8’s-profilers-with-chromium-different-from-using-them-with-v8-shells? class=bookmark>#</a></h2><p>与 V8 shell 不同，Chromium 是一个复杂的应用程序。以下是影响分析器使用的 Chromium 功能列表：<ul><li>每个渲染器都是一个单独的进程（好的，实际上不是每个渲染器，但我们省略此细节），因此它们不能共享相同的日志文件；<li>为渲染器进程构建的沙盒可防止其写入磁盘；<li>开发者工具出于自己的目的配置了分析器；<li>V8 的日志记录代码包含一些优化，以简化日志记录状态检查。</ul><h2 id=how-to-run-chromium-to-get-a-cpu-profile?>如何运行 Chromium 获取 CPU 分析日志？ <a href=#how-to-run-chromium-to-get-a-cpu-profile? class=bookmark>#</a></h2><p>以下是运行 Chromium 的方法，以便从进程开始时获取 CPU 分析日志：<pre class=language-bash><code class=language-bash>./Chromium --no-sandbox --user-data-dir<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>mktemp -d<span class="token variable">`</span></span> --incognito --js-flags<span class="token operator">=</span><span class="token string">'--prof'</span></code></pre><p>请注意，你不会在开发者工具中看到分析记录，因为所有数据都已记录到文件中，而不是开发者工具中。<h3 id=flags-description>标志说明 <a href=#flags-description class=bookmark>#</a></h3><p><code>--no-sandbox</code> 关闭渲染器沙盒，以便 chrome 可以写入日志文件。<p><code>--user-data-dir</code> 用于创建一个新的分析记录，用它来避免已安装扩展的缓存和潜在的副作用（可选）。<p><code>--incognito</code> 用于进一步防止结果受影响（可选）。<p><code>--js-flags</code> 包含传递给 V8 的标志：<ul><li><code>--logfile=%t.log</code> 指定日志文件的名称模式。<code>%t</code> 以毫秒为单位扩展到当前时间，因此每个进程都有自己的日志文件。你可以根据需要使用前缀和后缀，例如：<code>prefix-％t-suffix.log</code>。默认情况下，每个 isolate 都会获取一个单独的日志文件。<li><code>--prof</code> 告诉 V8 将统计分析信息写入日志文件。</ul><h2 id=android>Android <a href=#android class=bookmark>#</a></h2><p>Android 上的 Chrome 浏览器具有许多独特之处，这使其分析起来更加复杂。<ul><li>在设备上启动 Chrome 之前，必须通过 <code>adb</code> 编写命令行。结果，命令行中的引号有时会丢失，并且最好用逗号分隔 <code>--js-flags</code> 中的参数，而不要尝试使用空格和引号。<li>日志文件的路径必须指定为 Android 文件系统上可写位置的绝对路径。<li>Android 上用于渲染器进程的沙盒意味着即使使用 <code>--no-sandbox</code>，渲染器进程仍无法写入文件系统上的文件，因此，需要传递 <code>--single-process</code> 才能在与浏览器进程相同的进程中运行渲染器 。<li><code>.so</code> 嵌入在 Chrome 的 APK 中，这意味着符号化需要从 APK 内存地址转换为构建中未剥离的 <code>.so</code> 文件。</ul><p>以下命令可在 Android 上启用性能分析：<pre class=language-bash><code class=language-bash>./build/android/adb_chrome_public_command_line --no-sandbox --single-process --js-flags<span class="token operator">=</span><span class="token string">'--logfile=/storage/emulated/0/Download/%t.log,--prof'</span><br><span class="token operator">&lt;</span>Close and relaunch Chome on the Android device<span class="token operator">></span><br>adb pull /storage/emulated/0/Download/<span class="token operator">&lt;</span>logfile<span class="token operator">></span><br>./src/v8/tools/linux-tick-processor --apk-embedded-library<span class="token operator">=</span>out/Release/lib.unstripped/libchrome.so --preprocess <span class="token operator">&lt;</span>logfile<span class="token operator">></span></code></pre><h2 id=notes>注意 <a href=#notes class=bookmark>#</a></h2><p>在 Windows 下，请确保为 <code>chrome.dll</code> 打开 <code>.MAP</code> 文件创建功能，而不是为 <code>chrome.exe</code>。<article><footer><div><p>译者：不如怀念 (<a href=https://github.com/wang1212>@wang1212</a>).</div></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/docs/profile-chromium>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/docs/profile-chromium.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/dark-mode-toggle.mjs type=module></script><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>